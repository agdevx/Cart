# Household Management Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build invite code system and full household member management so users can join each other's households and collaborate on trips.

**Architecture:** Add `InviteCode` to the Household model. Build join/remove/transfer/regenerate operations through the existing layered architecture (Repository → Service → Controller). Add a household detail page to the frontend for member management. TDD throughout.

**Tech Stack:** .NET 10 (EF Core, SQLite), React (TanStack Query, React Router, Tailwind CSS), xUnit/Moq/FluentAssertions, Vitest/RTL

---

## Task 1: Add InviteCode to Household Model + Migration

**Files:**
- Modify: `backend/AGDevX.Cart.Shared/Models/Household.cs`
- Modify: `backend/AGDevX.Cart.Data/CartDbContext.cs`
- Create: `backend/AGDevX.Cart.Data/Migrations/` (auto-generated by EF Core)

**Step 1: Add InviteCode property to Household model**

In `backend/AGDevX.Cart.Shared/Models/Household.cs`, add:

```csharp
public class Household : BaseEntity
{
    public string? Name { get; set; }
    public string InviteCode { get; set; } = string.Empty;

    //== Navigation property to members who belong to this household
    public ICollection<HouseholdMember> Members { get; set; } = [];
}
```

**Step 2: Add unique index and max length in CartDbContext**

In `backend/AGDevX.Cart.Data/CartDbContext.cs`, add inside `OnModelCreating` after the User entity config:

```csharp
//== Configure Household invite code
modelBuilder.Entity<Household>(entity =>
{
    entity.Property(h => h.InviteCode).HasMaxLength(8);
    entity.HasIndex(h => h.InviteCode).IsUnique();
});
```

**Step 3: Generate EF Core migration**

Run from `backend/`:
```bash
dotnet ef migrations add AddHouseholdInviteCode --project AGDevX.Cart.Data --startup-project AGDevX.Cart.Api
```

Expected: Migration file created in `AGDevX.Cart.Data/Migrations/`.

**Step 4: Edit the migration to backfill existing households**

Open the generated migration file. In the `Up` method, after the `AddColumn` call, add SQL to backfill existing rows with random codes before making it non-nullable. The migration should:
1. Add column as nullable
2. Backfill with random 6-char codes via SQL
3. Make column non-nullable
4. Add unique index

Note: SQLite doesn't support `ALTER COLUMN`, so the generated migration may need manual adjustment. If EF generates it as non-nullable from the start, that's fine for SQLite since existing rows will get empty string default — we just need to backfill.

**Step 5: Apply migration and verify**

Run from `backend/`:
```bash
dotnet ef database update --project AGDevX.Cart.Data --startup-project AGDevX.Cart.Api
```

Expected: Migration applies successfully. Then verify:
```bash
dotnet build AGDevX.Cart.slnx --nologo -v q
```

Expected: Build succeeds with no errors.

**Step 6: Commit**

```bash
git add backend/AGDevX.Cart.Shared/Models/Household.cs backend/AGDevX.Cart.Data/CartDbContext.cs backend/AGDevX.Cart.Data/Migrations/
git commit -m "feat: Add InviteCode to Household model with migration"
```

---

## Task 2: Add Invite Code Generation Helper + Repository Methods

**Files:**
- Modify: `backend/AGDevX.Cart.Data/Repositories/IHouseholdRepository.cs`
- Modify: `backend/AGDevX.Cart.Data/Repositories/HouseholdRepository.cs`

**Step 1: Add new methods to IHouseholdRepository**

Add these method signatures to `IHouseholdRepository`:

```csharp
Task<Household?> GetByInviteCode(string inviteCode);
Task AddMember(HouseholdMember member);
Task RemoveMember(Guid householdId, Guid userId);
Task UpdateMemberRole(Guid householdId, Guid userId, string role);
```

**Step 2: Implement repository methods**

Add to `HouseholdRepository`:

```csharp
//== Find household by invite code
public async Task<Household?> GetByInviteCode(string inviteCode)
{
    return await context.Households
        .Include(h => h.Members)
        .FirstOrDefaultAsync(h => h.InviteCode == inviteCode);
}

//== Add a member to a household
public async Task AddMember(HouseholdMember member)
{
    context.HouseholdMembers.Add(member);
    await context.SaveChangesAsync();
}

//== Remove a member from a household
public async Task RemoveMember(Guid householdId, Guid userId)
{
    var member = await context.HouseholdMembers
        .FirstOrDefaultAsync(m => m.HouseholdId == householdId && m.UserId == userId);
    if (member != null)
    {
        context.HouseholdMembers.Remove(member);
        await context.SaveChangesAsync();
    }
}

//== Update a member's role
public async Task UpdateMemberRole(Guid householdId, Guid userId, string role)
{
    var member = await context.HouseholdMembers
        .FirstOrDefaultAsync(m => m.HouseholdId == householdId && m.UserId == userId);
    if (member != null)
    {
        member.Role = role;
        await context.SaveChangesAsync();
    }
}
```

**Step 3: Verify build**

```bash
dotnet build AGDevX.Cart.slnx --nologo -v q
```

Expected: Build succeeds.

**Step 4: Commit**

```bash
git add backend/AGDevX.Cart.Data/Repositories/
git commit -m "feat: Add repository methods for invite code lookup and member management"
```

---

## Task 3: Add Service Methods (with TDD)

**Files:**
- Modify: `backend/AGDevX.Cart.Services/IHouseholdService.cs`
- Modify: `backend/AGDevX.Cart.Services/HouseholdService.cs`
- Modify: `backend/AGDevX.Cart.Services.Tests/HouseholdServiceTests.cs`

**Step 1: Add new method signatures to IHouseholdService**

```csharp
Task<Household> JoinHousehold(Guid userId, string inviteCode);
Task RemoveMember(Guid requestingUserId, Guid householdId, Guid targetUserId);
Task TransferOwnership(Guid requestingUserId, Guid householdId, Guid newOwnerUserId);
Task<string> RegenerateInviteCode(Guid requestingUserId, Guid householdId);
Task<IEnumerable<HouseholdMember>> GetMembers(Guid userId, Guid householdId);
Task<string> GetInviteCode(Guid userId, Guid householdId);
```

**Step 2: Write failing tests for JoinHousehold**

Add to `HouseholdServiceTests.cs`:

```csharp
[Fact]
public async Task Should_JoinHousehold_When_ValidInviteCode()
{
    // Arrange
    var userId = Guid.NewGuid();
    var household = new Household
    {
        Id = Guid.NewGuid(),
        Name = "Test",
        InviteCode = "ABC123",
        Members = new List<HouseholdMember>()
    };

    _mockRepository.Setup(r => r.GetByInviteCode("ABC123")).ReturnsAsync(household);
    _mockRepository.Setup(r => r.AddMember(It.IsAny<HouseholdMember>())).Returns(Task.CompletedTask);

    // Act
    var result = await _service.JoinHousehold(userId, "ABC123");

    // Assert
    Assert.Equal(household.Id, result.Id);
    _mockRepository.Verify(r => r.AddMember(It.Is<HouseholdMember>(m =>
        m.UserId == userId && m.HouseholdId == household.Id && m.Role == "member"
    )), Times.Once);
}

[Fact]
public async Task Should_ThrowArgumentException_When_InvalidInviteCode()
{
    // Arrange
    _mockRepository.Setup(r => r.GetByInviteCode("INVALID")).ReturnsAsync((Household?)null);

    // Act & Assert
    await Assert.ThrowsAsync<ArgumentException>(() => _service.JoinHousehold(Guid.NewGuid(), "INVALID"));
}

[Fact]
public async Task Should_ThrowInvalidOperationException_When_AlreadyMember()
{
    // Arrange
    var userId = Guid.NewGuid();
    var household = new Household
    {
        Id = Guid.NewGuid(),
        Name = "Test",
        InviteCode = "ABC123",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = userId, HouseholdId = Guid.NewGuid(), Role = "member" }
        }
    };

    _mockRepository.Setup(r => r.GetByInviteCode("ABC123")).ReturnsAsync(household);

    // Act & Assert
    await Assert.ThrowsAsync<InvalidOperationException>(() => _service.JoinHousehold(userId, "ABC123"));
}
```

**Step 3: Run tests to verify they fail**

```bash
dotnet test AGDevX.Cart.Services.Tests --nologo -v q --filter "HouseholdServiceTests"
```

Expected: 3 new tests FAIL (methods don't exist yet).

**Step 4: Write failing tests for RemoveMember**

```csharp
[Fact]
public async Task Should_RemoveMember_When_OwnerRemovesOther()
{
    // Arrange
    var ownerId = Guid.NewGuid();
    var memberId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = ownerId, HouseholdId = householdId, Role = "owner" },
            new HouseholdMember { UserId = memberId, HouseholdId = householdId, Role = "member" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);
    _mockRepository.Setup(r => r.RemoveMember(householdId, memberId)).Returns(Task.CompletedTask);

    // Act
    await _service.RemoveMember(ownerId, householdId, memberId);

    // Assert
    _mockRepository.Verify(r => r.RemoveMember(householdId, memberId), Times.Once);
}

[Fact]
public async Task Should_RemoveMember_When_MemberRemovesSelf()
{
    // Arrange
    var memberId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = Guid.NewGuid(), HouseholdId = householdId, Role = "owner" },
            new HouseholdMember { UserId = memberId, HouseholdId = householdId, Role = "member" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);
    _mockRepository.Setup(r => r.RemoveMember(householdId, memberId)).Returns(Task.CompletedTask);

    // Act
    await _service.RemoveMember(memberId, householdId, memberId);

    // Assert
    _mockRepository.Verify(r => r.RemoveMember(householdId, memberId), Times.Once);
}

[Fact]
public async Task Should_ThrowUnauthorized_When_OwnerTriesToRemoveSelf()
{
    // Arrange
    var ownerId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = ownerId, HouseholdId = householdId, Role = "owner" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);

    // Act & Assert
    await Assert.ThrowsAsync<InvalidOperationException>(() =>
        _service.RemoveMember(ownerId, householdId, ownerId));
}

[Fact]
public async Task Should_ThrowUnauthorized_When_NonOwnerRemovesOther()
{
    // Arrange
    var memberId = Guid.NewGuid();
    var otherId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = Guid.NewGuid(), HouseholdId = householdId, Role = "owner" },
            new HouseholdMember { UserId = memberId, HouseholdId = householdId, Role = "member" },
            new HouseholdMember { UserId = otherId, HouseholdId = householdId, Role = "member" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);

    // Act & Assert
    await Assert.ThrowsAsync<UnauthorizedAccessException>(() =>
        _service.RemoveMember(memberId, householdId, otherId));
}
```

**Step 5: Write failing tests for TransferOwnership and RegenerateInviteCode**

```csharp
[Fact]
public async Task Should_TransferOwnership_When_OwnerTransfers()
{
    // Arrange
    var ownerId = Guid.NewGuid();
    var newOwnerId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = ownerId, HouseholdId = householdId, Role = "owner" },
            new HouseholdMember { UserId = newOwnerId, HouseholdId = householdId, Role = "member" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);
    _mockRepository.Setup(r => r.UpdateMemberRole(householdId, ownerId, "member")).Returns(Task.CompletedTask);
    _mockRepository.Setup(r => r.UpdateMemberRole(householdId, newOwnerId, "owner")).Returns(Task.CompletedTask);

    // Act
    await _service.TransferOwnership(ownerId, householdId, newOwnerId);

    // Assert
    _mockRepository.Verify(r => r.UpdateMemberRole(householdId, ownerId, "member"), Times.Once);
    _mockRepository.Verify(r => r.UpdateMemberRole(householdId, newOwnerId, "owner"), Times.Once);
}

[Fact]
public async Task Should_ThrowUnauthorized_When_NonOwnerTransfers()
{
    // Arrange
    var memberId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = Guid.NewGuid(), HouseholdId = householdId, Role = "owner" },
            new HouseholdMember { UserId = memberId, HouseholdId = householdId, Role = "member" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);

    // Act & Assert
    await Assert.ThrowsAsync<UnauthorizedAccessException>(() =>
        _service.TransferOwnership(memberId, householdId, Guid.NewGuid()));
}

[Fact]
public async Task Should_ThrowArgument_When_TransferToNonMember()
{
    // Arrange
    var ownerId = Guid.NewGuid();
    var nonMemberId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = ownerId, HouseholdId = householdId, Role = "owner" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);

    // Act & Assert
    await Assert.ThrowsAsync<ArgumentException>(() =>
        _service.TransferOwnership(ownerId, householdId, nonMemberId));
}

[Fact]
public async Task Should_RegenerateInviteCode_When_Owner()
{
    // Arrange
    var ownerId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        InviteCode = "OLD123",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = ownerId, HouseholdId = householdId, Role = "owner" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);
    _mockRepository.Setup(r => r.UpdateAsync(It.IsAny<Household>())).ReturnsAsync((Household h) => h);

    // Act
    var newCode = await _service.RegenerateInviteCode(ownerId, householdId);

    // Assert
    Assert.NotNull(newCode);
    Assert.NotEqual("OLD123", newCode);
    Assert.Equal(6, newCode.Length);
}

[Fact]
public async Task Should_ThrowUnauthorized_When_NonOwnerRegenerates()
{
    // Arrange
    var memberId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household
    {
        Id = householdId,
        Name = "Test",
        Members = new List<HouseholdMember>
        {
            new HouseholdMember { UserId = Guid.NewGuid(), HouseholdId = householdId, Role = "owner" },
            new HouseholdMember { UserId = memberId, HouseholdId = householdId, Role = "member" }
        }
    };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);

    // Act & Assert
    await Assert.ThrowsAsync<UnauthorizedAccessException>(() =>
        _service.RegenerateInviteCode(memberId, householdId));
}
```

**Step 6: Write failing tests for GetMembers and GetInviteCode**

```csharp
[Fact]
public async Task Should_GetMembers_When_UserIsMember()
{
    // Arrange
    var userId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var members = new List<HouseholdMember>
    {
        new HouseholdMember { UserId = userId, HouseholdId = householdId, Role = "owner" }
    };
    var household = new Household { Id = householdId, Name = "Test", Members = members };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);
    _mockRepository.Setup(r => r.IsUserMemberAsync(householdId, userId)).ReturnsAsync(true);

    // Act
    var result = await _service.GetMembers(userId, householdId);

    // Assert
    Assert.Single(result);
}

[Fact]
public async Task Should_GetInviteCode_When_UserIsMember()
{
    // Arrange
    var userId = Guid.NewGuid();
    var householdId = Guid.NewGuid();
    var household = new Household { Id = householdId, Name = "Test", InviteCode = "ABC123", Members = [] };

    _mockRepository.Setup(r => r.GetByIdAsync(householdId)).ReturnsAsync(household);
    _mockRepository.Setup(r => r.IsUserMemberAsync(householdId, userId)).ReturnsAsync(true);

    // Act
    var result = await _service.GetInviteCode(userId, householdId);

    // Assert
    Assert.Equal("ABC123", result);
}
```

**Step 7: Run all tests to verify they fail**

```bash
dotnet test AGDevX.Cart.Services.Tests --nologo -v q --filter "HouseholdServiceTests"
```

Expected: All new tests FAIL (methods not implemented yet). The 1 original test should still PASS.

**Step 8: Implement all service methods**

Add a static helper method and new methods to `HouseholdService`:

```csharp
private static readonly char[] InviteCodeChars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789".ToCharArray();

private static string GenerateInviteCode()
{
    var random = new Random();
    return new string(Enumerable.Range(0, 6).Select(_ => InviteCodeChars[random.Next(InviteCodeChars.Length)]).ToArray());
}
```

Update `CreateHouseholdAsync` to set `InviteCode = GenerateInviteCode()` on the new household.

Then implement:

```csharp
//== Join a household via invite code
public async Task<Household> JoinHousehold(Guid userId, string inviteCode)
{
    var household = await repository.GetByInviteCode(inviteCode)
        ?? throw new ArgumentException("Invalid invite code");

    if (household.Members.Any(m => m.UserId == userId))
    {
        throw new InvalidOperationException("User is already a member of this household");
    }

    var member = new HouseholdMember
    {
        Id = Guid.NewGuid(),
        HouseholdId = household.Id,
        UserId = userId,
        Role = "member",
        JoinedAt = DateTime.UtcNow,
        CreatedBy = userId.ToString(),
        CreatedDate = DateTime.UtcNow,
        ModifiedBy = userId.ToString(),
        ModifiedDate = DateTime.UtcNow
    };

    await repository.AddMember(member);
    return household;
}

//== Remove a member (owner removes other, or member removes self)
public async Task RemoveMember(Guid requestingUserId, Guid householdId, Guid targetUserId)
{
    var household = await repository.GetByIdAsync(householdId)
        ?? throw new ArgumentException("Household not found");

    var requestingMember = household.Members.FirstOrDefault(m => m.UserId == requestingUserId)
        ?? throw new UnauthorizedAccessException("User is not a member of this household");

    var isOwner = requestingMember.Role == "owner";
    var isSelf = requestingUserId == targetUserId;

    //== Owner can't remove self (must transfer ownership first or delete household)
    if (isOwner && isSelf)
    {
        throw new InvalidOperationException("Owner cannot remove themselves. Transfer ownership first or delete the household.");
    }

    //== Non-owners can only remove themselves
    if (!isOwner && !isSelf)
    {
        throw new UnauthorizedAccessException("Only the owner can remove other members");
    }

    await repository.RemoveMember(householdId, targetUserId);
}

//== Transfer ownership to another member
public async Task TransferOwnership(Guid requestingUserId, Guid householdId, Guid newOwnerUserId)
{
    var household = await repository.GetByIdAsync(householdId)
        ?? throw new ArgumentException("Household not found");

    var isOwner = household.Members.Any(m => m.UserId == requestingUserId && m.Role == "owner");
    if (!isOwner)
    {
        throw new UnauthorizedAccessException("Only the owner can transfer ownership");
    }

    var newOwnerIsMember = household.Members.Any(m => m.UserId == newOwnerUserId);
    if (!newOwnerIsMember)
    {
        throw new ArgumentException("Target user is not a member of this household");
    }

    await repository.UpdateMemberRole(householdId, requestingUserId, "member");
    await repository.UpdateMemberRole(householdId, newOwnerUserId, "owner");
}

//== Regenerate invite code (owner only)
public async Task<string> RegenerateInviteCode(Guid requestingUserId, Guid householdId)
{
    var household = await repository.GetByIdAsync(householdId)
        ?? throw new ArgumentException("Household not found");

    var isOwner = household.Members.Any(m => m.UserId == requestingUserId && m.Role == "owner");
    if (!isOwner)
    {
        throw new UnauthorizedAccessException("Only the owner can regenerate the invite code");
    }

    household.InviteCode = GenerateInviteCode();
    household.ModifiedBy = requestingUserId.ToString();
    household.ModifiedDate = DateTime.UtcNow;
    await repository.UpdateAsync(household);

    return household.InviteCode;
}

//== Get household members (member access)
public async Task<IEnumerable<HouseholdMember>> GetMembers(Guid userId, Guid householdId)
{
    var household = await repository.GetByIdAsync(householdId)
        ?? throw new ArgumentException("Household not found");

    if (!await repository.IsUserMemberAsync(householdId, userId))
    {
        throw new UnauthorizedAccessException("User is not a member of this household");
    }

    return household.Members;
}

//== Get invite code (member access)
public async Task<string> GetInviteCode(Guid userId, Guid householdId)
{
    var household = await repository.GetByIdAsync(householdId)
        ?? throw new ArgumentException("Household not found");

    if (!await repository.IsUserMemberAsync(householdId, userId))
    {
        throw new UnauthorizedAccessException("User is not a member of this household");
    }

    return household.InviteCode;
}
```

**Step 9: Run all service tests**

```bash
dotnet test AGDevX.Cart.Services.Tests --nologo -v q --filter "HouseholdServiceTests"
```

Expected: All tests PASS (original + 13 new).

**Step 10: Commit**

```bash
git add backend/AGDevX.Cart.Services/ backend/AGDevX.Cart.Services.Tests/
git commit -m "feat: Add household join, member management, and invite code service methods"
```

---

## Task 4: Add Controller Endpoints (with TDD)

**Files:**
- Modify: `backend/AGDevX.Cart.Api/Controllers/HouseholdController.cs`
- Modify: `backend/AGDevX.Cart.Api.Tests/Controllers/HouseholdControllerTests.cs`

**Step 1: Write failing controller tests**

Add to `HouseholdControllerTests.cs`. All tests follow the existing pattern — create mock service, set up ClaimsPrincipal, call controller method, assert result type.

```csharp
//== Join household tests
[Fact]
public async Task Should_ReturnOk_When_JoinHouseholdSuccessful()
{
    // Arrange
    var mockService = new Mock<IHouseholdService>();
    var controller = new HouseholdController(mockService.Object);
    var userId = Guid.NewGuid();

    var user = new ClaimsPrincipal(new ClaimsIdentity([
        new Claim(ClaimTypes.NameIdentifier, userId.ToString())
    ]));

    controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };

    var household = new Household { Id = Guid.NewGuid(), Name = "Test" };
    mockService.Setup(s => s.JoinHousehold(userId, "ABC123")).ReturnsAsync(household);

    // Act
    var result = await controller.JoinHousehold(new JoinHouseholdRequest { InviteCode = "ABC123" });

    // Assert
    var okResult = result.Should().BeOfType<OkObjectResult>().Subject;
    okResult.Value.Should().BeEquivalentTo(household);
}

[Fact]
public async Task Should_ReturnBadRequest_When_InvalidInviteCode()
{
    // Arrange
    var mockService = new Mock<IHouseholdService>();
    var controller = new HouseholdController(mockService.Object);
    var userId = Guid.NewGuid();

    var user = new ClaimsPrincipal(new ClaimsIdentity([
        new Claim(ClaimTypes.NameIdentifier, userId.ToString())
    ]));

    controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };

    mockService.Setup(s => s.JoinHousehold(userId, "INVALID"))
        .ThrowsAsync(new ArgumentException("Invalid invite code"));

    // Act
    var result = await controller.JoinHousehold(new JoinHouseholdRequest { InviteCode = "INVALID" });

    // Assert
    result.Should().BeOfType<BadRequestObjectResult>();
}

//== Get members test
[Fact]
public async Task Should_ReturnOk_When_GetMembersSuccessful()
{
    // Arrange
    var mockService = new Mock<IHouseholdService>();
    var controller = new HouseholdController(mockService.Object);
    var userId = Guid.NewGuid();
    var householdId = Guid.NewGuid();

    var user = new ClaimsPrincipal(new ClaimsIdentity([
        new Claim(ClaimTypes.NameIdentifier, userId.ToString())
    ]));

    controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };

    var members = new List<HouseholdMember>
    {
        new HouseholdMember { UserId = userId, HouseholdId = householdId, Role = "owner" }
    };

    mockService.Setup(s => s.GetMembers(userId, householdId)).ReturnsAsync(members);

    // Act
    var result = await controller.GetMembers(householdId);

    // Assert
    var okResult = result.Should().BeOfType<OkObjectResult>().Subject;
    okResult.Value.Should().BeEquivalentTo(members);
}

//== Remove member test
[Fact]
public async Task Should_ReturnNoContent_When_RemoveMemberSuccessful()
{
    // Arrange
    var mockService = new Mock<IHouseholdService>();
    var controller = new HouseholdController(mockService.Object);
    var userId = Guid.NewGuid();
    var targetUserId = Guid.NewGuid();
    var householdId = Guid.NewGuid();

    var user = new ClaimsPrincipal(new ClaimsIdentity([
        new Claim(ClaimTypes.NameIdentifier, userId.ToString())
    ]));

    controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };

    mockService.Setup(s => s.RemoveMember(userId, householdId, targetUserId)).Returns(Task.CompletedTask);

    // Act
    var result = await controller.RemoveMember(householdId, targetUserId);

    // Assert
    result.Should().BeOfType<NoContentResult>();
}

//== Transfer ownership test
[Fact]
public async Task Should_ReturnNoContent_When_TransferOwnershipSuccessful()
{
    // Arrange
    var mockService = new Mock<IHouseholdService>();
    var controller = new HouseholdController(mockService.Object);
    var userId = Guid.NewGuid();
    var newOwnerId = Guid.NewGuid();
    var householdId = Guid.NewGuid();

    var user = new ClaimsPrincipal(new ClaimsIdentity([
        new Claim(ClaimTypes.NameIdentifier, userId.ToString())
    ]));

    controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };

    mockService.Setup(s => s.TransferOwnership(userId, householdId, newOwnerId)).Returns(Task.CompletedTask);

    // Act
    var result = await controller.TransferOwnership(householdId, new TransferOwnershipRequest { UserId = newOwnerId });

    // Assert
    result.Should().BeOfType<NoContentResult>();
}

//== Get invite code test
[Fact]
public async Task Should_ReturnOk_When_GetInviteCodeSuccessful()
{
    // Arrange
    var mockService = new Mock<IHouseholdService>();
    var controller = new HouseholdController(mockService.Object);
    var userId = Guid.NewGuid();
    var householdId = Guid.NewGuid();

    var user = new ClaimsPrincipal(new ClaimsIdentity([
        new Claim(ClaimTypes.NameIdentifier, userId.ToString())
    ]));

    controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };

    mockService.Setup(s => s.GetInviteCode(userId, householdId)).ReturnsAsync("XK7M2P");

    // Act
    var result = await controller.GetInviteCode(householdId);

    // Assert
    var okResult = result.Should().BeOfType<OkObjectResult>().Subject;
    okResult.Value.Should().BeEquivalentTo(new { inviteCode = "XK7M2P" });
}

//== Regenerate invite code test
[Fact]
public async Task Should_ReturnOk_When_RegenerateInviteCodeSuccessful()
{
    // Arrange
    var mockService = new Mock<IHouseholdService>();
    var controller = new HouseholdController(mockService.Object);
    var userId = Guid.NewGuid();
    var householdId = Guid.NewGuid();

    var user = new ClaimsPrincipal(new ClaimsIdentity([
        new Claim(ClaimTypes.NameIdentifier, userId.ToString())
    ]));

    controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };

    mockService.Setup(s => s.RegenerateInviteCode(userId, householdId)).ReturnsAsync("NEW456");

    // Act
    var result = await controller.RegenerateInviteCode(householdId);

    // Assert
    var okResult = result.Should().BeOfType<OkObjectResult>().Subject;
    okResult.Value.Should().BeEquivalentTo(new { inviteCode = "NEW456" });
}
```

**Step 2: Run tests to verify they fail**

```bash
dotnet test AGDevX.Cart.Api.Tests --nologo -v q --filter "HouseholdControllerTests"
```

Expected: New tests FAIL (methods/types don't exist). Existing 9 tests PASS.

**Step 3: Add request DTOs and implement controller endpoints**

Add request record types at the top of `HouseholdController.cs` (or in a separate file if preferred — match existing pattern):

```csharp
public record JoinHouseholdRequest
{
    public string InviteCode { get; init; } = string.Empty;
}

public record TransferOwnershipRequest
{
    public Guid UserId { get; init; }
}
```

Note: The join endpoint must be at `api/households/join` (plural) to match the frontend. Since the controller route is `api/[controller]` (which gives `api/Household`), use `[Route("api/households/join")]` explicitly on the join method, or create a separate controller. Simplest: use `[HttpPost("/api/households/join")]` with absolute path.

Add to `HouseholdController`:

```csharp
//== Join a household via invite code
[HttpPost("/api/households/join")]
public async Task<IActionResult> JoinHousehold([FromBody] JoinHouseholdRequest request)
{
    try
    {
        var userId = User.GetUserId();
        var household = await householdService.JoinHousehold(userId, request.InviteCode);
        return Ok(household);
    }
    catch (UnauthorizedAccessException ex)
    {
        return Unauthorized(new { errorCode = "UNAUTHORIZED", message = ex.Message });
    }
    catch (ArgumentException ex)
    {
        return BadRequest(new { errorCode = "INVALID_INVITE_CODE", message = ex.Message });
    }
    catch (InvalidOperationException ex)
    {
        return Conflict(new { errorCode = "ALREADY_MEMBER", message = ex.Message });
    }
}

//== Get household members
[HttpGet("{id}/members")]
public async Task<IActionResult> GetMembers(Guid id)
{
    try
    {
        var userId = User.GetUserId();
        var members = await householdService.GetMembers(userId, id);
        return Ok(members);
    }
    catch (UnauthorizedAccessException ex)
    {
        return Unauthorized(new { errorCode = "UNAUTHORIZED", message = ex.Message });
    }
}

//== Remove a member from a household
[HttpDelete("{id}/members/{targetUserId}")]
public async Task<IActionResult> RemoveMember(Guid id, Guid targetUserId)
{
    try
    {
        var userId = User.GetUserId();
        await householdService.RemoveMember(userId, id, targetUserId);
        return NoContent();
    }
    catch (UnauthorizedAccessException ex)
    {
        return Unauthorized(new { errorCode = "UNAUTHORIZED", message = ex.Message });
    }
    catch (InvalidOperationException ex)
    {
        return BadRequest(new { errorCode = "INVALID_OPERATION", message = ex.Message });
    }
    catch (ArgumentException ex)
    {
        return NotFound(new { errorCode = "NOT_FOUND", message = ex.Message });
    }
}

//== Transfer household ownership
[HttpPut("{id}/owner")]
public async Task<IActionResult> TransferOwnership(Guid id, [FromBody] TransferOwnershipRequest request)
{
    try
    {
        var userId = User.GetUserId();
        await householdService.TransferOwnership(userId, id, request.UserId);
        return NoContent();
    }
    catch (UnauthorizedAccessException ex)
    {
        return Unauthorized(new { errorCode = "UNAUTHORIZED", message = ex.Message });
    }
    catch (ArgumentException ex)
    {
        return BadRequest(new { errorCode = "INVALID_REQUEST", message = ex.Message });
    }
}

//== Get invite code
[HttpGet("{id}/invite-code")]
public async Task<IActionResult> GetInviteCode(Guid id)
{
    try
    {
        var userId = User.GetUserId();
        var code = await householdService.GetInviteCode(userId, id);
        return Ok(new { inviteCode = code });
    }
    catch (UnauthorizedAccessException ex)
    {
        return Unauthorized(new { errorCode = "UNAUTHORIZED", message = ex.Message });
    }
}

//== Regenerate invite code
[HttpPost("{id}/invite-code")]
public async Task<IActionResult> RegenerateInviteCode(Guid id)
{
    try
    {
        var userId = User.GetUserId();
        var code = await householdService.RegenerateInviteCode(userId, id);
        return Ok(new { inviteCode = code });
    }
    catch (UnauthorizedAccessException ex)
    {
        return Unauthorized(new { errorCode = "UNAUTHORIZED", message = ex.Message });
    }
}
```

**Step 4: Run all controller tests**

```bash
dotnet test AGDevX.Cart.Api.Tests --nologo -v q --filter "HouseholdControllerTests"
```

Expected: All tests PASS (9 existing + 7 new = 16 total).

**Step 5: Run entire backend test suite**

```bash
dotnet test AGDevX.Cart.slnx --nologo -v q
```

Expected: All tests pass.

**Step 6: Commit**

```bash
git add backend/AGDevX.Cart.Api/
git commit -m "feat: Add household join, member management, and invite code controller endpoints"
```

---

## Task 5: Frontend — New Queries and Mutations

**Files:**
- Create: `frontend/src/apis/agdevx-cart-api/household/use-household-members.query.ts`
- Create: `frontend/src/apis/agdevx-cart-api/household/use-invite-code.query.ts`
- Create: `frontend/src/apis/agdevx-cart-api/household/remove-household-member.mutation.ts`
- Create: `frontend/src/apis/agdevx-cart-api/household/transfer-household-ownership.mutation.ts`
- Create: `frontend/src/apis/agdevx-cart-api/household/regenerate-invite-code.mutation.ts`
- Modify: `frontend/src/apis/agdevx-cart-api/models/household.ts`
- Create test files for each

**Step 1: Update Household model to include inviteCode**

In `frontend/src/apis/agdevx-cart-api/models/household.ts`, add `inviteCode` to the Household interface:

```typescript
export interface Household {
  id: string;
  name: string | null;
  inviteCode?: string;
  createdBy: string | null;
  createdDate: string;
  modifiedBy: string | null;
  modifiedDate: string | null;
}
```

**Step 2: Create use-household-members.query.ts**

```typescript
// ABOUTME: Query hook for fetching household members
// ABOUTME: Returns list of members with roles for a specific household

import { useQuery } from '@tanstack/react-query'
import { apiFetch } from '../agdevx-cart-api-config'
import type { HouseholdMember } from '../models/household'
import { useAuth } from '@/auth/use-auth'

export const useHouseholdMembersQuery = (householdId: string) => {
  const { token } = useAuth()

  return useQuery({
    queryKey: ['household', householdId, 'members'],
    queryFn: async (): Promise<HouseholdMember[]> => {
      const response = await apiFetch(`/api/household/${householdId}/members`, { token })
      if (!response.ok) {
        throw new Error('Failed to fetch household members')
      }
      return response.json()
    },
    enabled: !!token && !!householdId,
  })
}
```

**Step 3: Create use-invite-code.query.ts**

```typescript
// ABOUTME: Query hook for fetching household invite code
// ABOUTME: Returns invite code for sharing with potential members

import { useQuery } from '@tanstack/react-query'
import { apiFetch } from '../agdevx-cart-api-config'
import { useAuth } from '@/auth/use-auth'

export const useInviteCodeQuery = (householdId: string) => {
  const { token } = useAuth()

  return useQuery({
    queryKey: ['household', householdId, 'invite-code'],
    queryFn: async (): Promise<string> => {
      const response = await apiFetch(`/api/household/${householdId}/invite-code`, { token })
      if (!response.ok) {
        throw new Error('Failed to fetch invite code')
      }
      const data = await response.json()
      return data.inviteCode
    },
    enabled: !!token && !!householdId,
  })
}
```

**Step 4: Create remove-household-member.mutation.ts**

```typescript
// ABOUTME: Mutation hook for removing a household member
// ABOUTME: Allows owner to remove members or members to leave

import { useMutation, useQueryClient } from '@tanstack/react-query'
import { apiFetch } from '../agdevx-cart-api-config'
import { useAuth } from '@/auth/use-auth'

interface RemoveMemberRequest {
  householdId: string
  userId: string
}

export const useRemoveHouseholdMemberMutation = () => {
  const { token } = useAuth()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (request: RemoveMemberRequest): Promise<void> => {
      const response = await apiFetch(
        `/api/household/${request.householdId}/members/${request.userId}`,
        { method: 'DELETE', token }
      )
      if (!response.ok) {
        throw new Error('Failed to remove member')
      }
    },
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({ queryKey: ['household', variables.householdId, 'members'] })
      queryClient.invalidateQueries({ queryKey: ['households'] })
    },
  })
}
```

**Step 5: Create transfer-household-ownership.mutation.ts**

```typescript
// ABOUTME: Mutation hook for transferring household ownership
// ABOUTME: Allows current owner to transfer ownership to another member

import { useMutation, useQueryClient } from '@tanstack/react-query'
import { apiFetch } from '../agdevx-cart-api-config'
import { useAuth } from '@/auth/use-auth'

interface TransferOwnershipRequest {
  householdId: string
  userId: string
}

export const useTransferHouseholdOwnershipMutation = () => {
  const { token } = useAuth()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (request: TransferOwnershipRequest): Promise<void> => {
      const response = await apiFetch(
        `/api/household/${request.householdId}/owner`,
        {
          method: 'PUT',
          body: JSON.stringify({ userId: request.userId }),
          token,
        }
      )
      if (!response.ok) {
        throw new Error('Failed to transfer ownership')
      }
    },
    onSuccess: (_data, variables) => {
      queryClient.invalidateQueries({ queryKey: ['household', variables.householdId, 'members'] })
    },
  })
}
```

**Step 6: Create regenerate-invite-code.mutation.ts**

```typescript
// ABOUTME: Mutation hook for regenerating household invite code
// ABOUTME: Allows owner to generate a new invite code, invalidating the old one

import { useMutation, useQueryClient } from '@tanstack/react-query'
import { apiFetch } from '../agdevx-cart-api-config'
import { useAuth } from '@/auth/use-auth'

export const useRegenerateInviteCodeMutation = () => {
  const { token } = useAuth()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (householdId: string): Promise<string> => {
      const response = await apiFetch(
        `/api/household/${householdId}/invite-code`,
        { method: 'POST', token }
      )
      if (!response.ok) {
        throw new Error('Failed to regenerate invite code')
      }
      const data = await response.json()
      return data.inviteCode
    },
    onSuccess: (_data, householdId) => {
      queryClient.invalidateQueries({ queryKey: ['household', householdId, 'invite-code'] })
    },
  })
}
```

**Step 7: Write tests for all new queries and mutations**

Follow the exact same test patterns already established in the codebase (see the test files read in the conversation context). Each test file mocks `useAuth`, mocks `apiFetch` with `{ ok: true, json: async () => data } as unknown as Response`, renders the hook, and asserts on the result.

Create test files:
- `use-household-members.query.test.tsx`
- `use-invite-code.query.test.tsx`
- `remove-household-member.mutation.test.tsx`
- `transfer-household-ownership.mutation.test.tsx`
- `regenerate-invite-code.mutation.test.tsx`

Each should have 2-3 tests: success case, error case, and (for mutations) query invalidation.

**Step 8: Run frontend tests**

```bash
cd ../frontend && npx vitest run --reporter=verbose 2>&1 | tail -30
```

Expected: All tests pass including new ones.

**Step 9: Commit**

```bash
git add frontend/src/apis/
git commit -m "feat: Add frontend queries and mutations for household member management"
```

---

## Task 6: Frontend — Household Detail Page

**Files:**
- Create: `frontend/src/pages/household-detail-page.tsx`
- Create: `frontend/src/pages/household-detail-page.test.tsx`
- Modify: `frontend/src/pages/household-page.tsx` (make household cards clickable)
- Modify: `frontend/src/app.tsx` (add route)

**Step 1: Create household-detail-page.tsx**

Build the page using:
- `useHouseholdMembersQuery(householdId)` for the member list
- `useInviteCodeQuery(householdId)` for the invite code
- `useRemoveHouseholdMemberMutation()` for remove/leave
- `useTransferHouseholdOwnershipMutation()` for ownership transfer
- `useRegenerateInviteCodeMutation()` for code regeneration
- `useAuth()` to determine if current user is owner

Layout:
1. Header with household name and back button
2. Invite code card with copy button (owner sees regenerate button)
3. Members list — each row shows display name, role badge, and action buttons based on role

**Step 2: Add route in app.tsx**

Add import and route:
```typescript
import { HouseholdDetailPage } from '@/pages/household-detail-page'

// In Routes, add:
<Route path="/household/:id" element={<ProtectedRoute><HouseholdDetailPage /></ProtectedRoute>} />
```

Place it BEFORE `/household/create` and `/household/join` to avoid route conflicts.

**Step 3: Update household-page.tsx**

Wrap each household card in a `<Link to={`/household/${household.id}`}>` so clicking navigates to the detail page.

**Step 4: Write tests for household-detail-page**

Test:
- Renders loading state
- Renders member list with roles
- Owner sees remove buttons and transfer ownership buttons
- Non-owner sees leave button
- Invite code is displayed
- Owner sees regenerate button

**Step 5: Run all frontend tests**

```bash
cd ../frontend && npx vitest run --reporter=verbose 2>&1 | tail -30
```

Expected: All tests pass.

**Step 6: Commit**

```bash
git add frontend/src/
git commit -m "feat: Add household detail page with member management UI"
```

---

## Task 7: Integration Testing & Cleanup

**Step 1: Run full backend test suite**

```bash
cd backend && dotnet test AGDevX.Cart.slnx --nologo -v q
```

Expected: All tests pass.

**Step 2: Run full frontend test suite**

```bash
cd ../frontend && npx vitest run --reporter=verbose 2>&1 | tail -30
```

Expected: All tests pass.

**Step 3: Manual smoke test**

Start backend and frontend, then verify:
1. Create a household → invite code is generated and visible on detail page
2. Copy invite code → join from another account → member appears in list
3. Owner can remove a member
4. Member can leave (remove self)
5. Owner can transfer ownership
6. Owner can regenerate invite code

**Step 4: Final commit if any cleanup needed**

```bash
git add -A
git commit -m "chore: Final cleanup for household management feature"
```
